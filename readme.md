#  电梯调度系统

CPU调度是多道程序操作系统的基础。了解操作系统在进程/线程间进行的CPU调度是了解操作系统的重要部分。对于调度系统，电梯的调度系统是较为典型而常见的例子。本例通过实现电梯调度程序，探究调度程序的运作方式。



## 项目分析

### 项目背景

​	某栋楼共有20层（约定楼层编号为1…20），楼内共有五部互联（即统一调度，在电梯外对一个电梯下指令时，指令可能调度到任意电梯）的电梯。基于线程的思想，编写电梯调度程序。



### 项目目的

- 学习调度算法
- 通过实现电梯调度的功能，体会操作系统调度过程
- 学习特定环境下多线程编程的方法



### 功能需求

- 模拟电梯内部的功能键与状态显示：数字楼层键、上升及下降状态、报警键、当前楼层数
- 模拟电梯外部功能：上行、下行按键、电梯楼层显示
- 其他功能：
  - 所有电梯外部按钮互联
  - 所有电梯初始状态在第一层
  - 每个电梯在上层/下层没有相应请求的状况下，应该在原地保持不动



## 开发工具

- 开发语言：C/C++
- 图形界面框架：Qt5
- 开发工具：CLion Professional + CMake



## 术语表

| 术语     | 含义                                                         |
| -------- | ------------------------------------------------------------ |
| 请求     | 指经过电梯内外的控制面板发送的，用户对电梯运行的指示。包含内部请求，即由电梯内面板发送的仅包含楼层信息的请求，与外部请求，即电梯外面板发送的，包含楼层与方向信息的请求。 |
| 调度     | 指程序中运行的一系列算法，统一处理各个请求，并将请求合理地发送给一步电梯形成任务，或挂起这个请求等待稍后进行调度。 |
| 任务     | 当一个请求由调度程序发给特定电梯时，即成为该电梯的任务。     |
| 电梯     | 指电梯的实体，包含电梯当前的运行状态（运行方向，是否停止，所在楼层，是否处于警报状态）以及特定电梯实体维护的在调度过程中收到的任务。 |
| 运行逻辑 | 指对于单个电梯而言，依据所保存的收到的任务信息与自身当前的状态，对接下来的状态进行调整的算法。 |
| 优先级   | 对于某一请求和一特定的电梯，若请求的楼层在电梯运行方向上，则优先级为电梯当前楼层到请求的楼层的距离（优先级越大，优先级别越高），若方向相反，则优先级视为不存在。 |
| 挂起     | 若调度程序收到某一请求时，所有电梯对其优先级均不存在，则该请求被暂缓调度。 |
| 挂起队列 | 保存所有挂起的请求信息的队列。                               |
| 重调度   | 在某一电梯的状态发生改变，满足：电梯停止或电梯运行方向与挂起队列队首请求相同时，对挂起队列中所有请求重新运行调度算法的过程。 |
| 停止     | 指电梯保持在某一楼层，且收到新的任务前不会运行的状态         |
| 停靠     | 指电梯因任务需要暂时保持在某一楼层，并保持向标示方向继续运行的趋势的状态，随后的状态取决于任务，可能继续运行或转为停止 |
| 运行     | 指电梯正在按标示方向移动的状态                               |



## 设计

在本项目中，由于电梯多于一部，调度部分主要需要实现接受不同的内部/外部请求，并通过特定的算法将请求的任务分发至某个电梯。而对于某一特定的电梯，需要保存收到的任务，并建立一定的运行逻辑，达到高效地完成收到任务的目的。



### 调度算法

考虑到现实中电梯的运行情况，为缩短每个外部请求成为任务的时间，本系统采用以优先级为标准的调度算法。对于内部请求，则直接调度到对应电梯。同时为了减少产生饥饿的可能，对挂起的请求进行FIFO的管理，使得先被挂起的请求倾向于先得到重调度。

- 调度原理：
  - 对于内部请求，根据请求包含的电梯编号和楼层，直接调度该请求形成任务
  - 对于外部请求，分别对每部电梯计算优先级：
    - 若所有电梯优先级均不存在，将该请求挂起
    - 否则，选择优先级最高的电梯，将该请求调度为此电梯的任务
- 调度模式：非剥夺模式。所有请求在完成调度后，调度程序即丧失对请求相关数据的所有权，请求的信息转化为任务信息由电梯维护。
- 调度类型：中级调度。通过挂起暂时无法完成调度的请求，为之后产生的、可以得到调度的请求的完成让出资源。
- 调度流程<br>![](http://ww1.sinaimg.cn/large/006m4mAkly1g2g1zc9ew1j30du0id0tm.jpg)
- 外部请求状态图<br>![](![](https://ws1.sinaimg.cn/large/006m4mAkly1g2gdj6cuz3j30f108naam.jpg))



### 任务管理算法

任务管理采用轮询算法。处于对并行工作的需要，将每部电梯的主要任务管理工作各自独立，管理算法每隔一定的时间检查当前状态以及对应运行方向的任务队列情况，并对电梯的状态做出改变。

- 调度原理
  - 当电梯目前停止时：
    - 若各方向队列均为空，则保持停止
    - 若任意方向有不在当前层的任务，则按照有任务的方向（同时有任务时，上行优先）开始运行
    - 若任意方向有当前层的任务，则电梯转为按该任务方向的停靠模式（内请求任务无方向时，默认上行）
  - 当电梯目前按任意方向停靠时：
    - 若停靠方向上无任务，或按停靠方向已到达建筑顶/底层时，转为停止
    - 否则，将当前方向的任务列表中目标楼层在反方向的任务调整至另一方向任务列表，随后若列表为空则转为停止，否则转为按该停靠方向运行
  - 当电梯目前按任意方向运行时：
    - 将当前方向的任务列表中目标楼层在反方向的任务调整至另一方向任务列表
    - 若当前所在楼层不在该方向任务目标内，则向上移动一层，仍保持该方向运行状态
    - 否则，若当前楼层在在该方向任务目标
      - 若当前方向与任务方向一致，则转为按该方向停靠状态，且认为该任务完成
      - 否则，若该任务为本方向最后一个任务，则转为反方向停靠状态，否则将该任务调整至反方向任务列表等待稍后完成
- 任务管理流程图<br>![](![](https://ws1.sinaimg.cn/large/006m4mAkly1g2ge17hx42j30mq0gdjsr.jpg))

### 类设计

#### 界面相关类

1. MainWindowController类

   继承自QMainWindow类，作为程序的主窗口和最高层的ViewController，直接或间接持有并管理其他所有的界面类和模型类，同时帮助数据在二者之间传递。

2. StatusButton类

   继承自QPushButton类，为模拟电梯按钮可以传递操作，也可以通过灯光展示状态的属性，自定义的界面空间。储存两种不同的样式表并可以在二者间切换，同时也具有普通点击按钮的其他功能。

3. InternalPanel类

   继承自QWidget类，为电梯内部控制面板的界面和控制器。持有并管理电梯内的楼层按钮、紧急按钮、方向指示、楼层指示控件并提供更改空间内容的外部接口。

4. ExternalPanel类

   继承自QWidget类，为电梯外部的控制面的界面和控制器。持有并管理各楼层的楼层数标示以及每个楼层控制电梯的上行、下行按钮并提供对外接口。

#### 模型相关类

1. Elevator类

   继承自QThread类，表示电梯实体的状态、收到的任务以及封装的任务管理算法。同时包含两个子类型：

   - Status类型，保存电梯当前楼层、运行方向和状态、是否处于紧急状况的信息
   - Target类型，保存单一任务的细节，包括任务目标楼层和方向

2. Dispatcher类

   继承自QObject类，是调度算法的抽象实体。持有并管理所有的电梯实例，也代理电梯实例和界面之间的信息传递。



